name: CI
on: [pull_request]
jobs:
  lhci:
    name: Lighthouse
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js 20.x
        uses: actions/setup-node@v3
        with:
          node-version: 20.x

      - name: yarn install, build
        run: |
          yarn install
          yarn run build

      - name: run Lighthouse CI
        run: |
          yarn lhci autorun --upload.target=filesystem --upload.outputDir=./test

      - name: List generated files
        run: ls ./test

      - name: Get JSON filename
        id: get-json-filename
        run: echo "::set-output name=filename::$(ls ./test/*.report.json)"

      - name: Show JSON filename
        run: echo "${{ steps.get-json-filename.outputs.filename }}"

      - name: Extract first-contentful-paint score
        id: extract-fcp-score
        run: |
          filename=$(echo "${{ steps.get-json-filename.outputs.filename }}")
          fcp_score=$(jq -r '.audits["first-contentful-paint"].score' "${filename}")
          echo "::set-output name=fcp-score::${fcp_score}"
          echo "FCP_SCORE=${fcp_score}" >> $GITHUB_ENV

      - name: Show FCP score
        run: echo "test ${{ steps.extract-fcp-score.outputs.fcp-score }}"

      - name: Add information to PR
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.TEST }}
          script: |
            const fcpScore = process.env["FCP_SCORE"];
            const icon = '<svg class="octicon octicon-flame" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5c.832 0 1.5.5 1.5 1.228 0 .876-.68 2.017-2.029 3.486l-.471.505a.5.5 0 0 1-.942 0l-.471-.505C6.18 4.745 5.5 3.605 5.5 2.728 5.5 2 6.168 1.5 7 1.5zM8 14c-.5-.5-.878-.972-1.134-1.418C6.701 12.64 6.5 12.088 6.5 11.5c0-.723.495-1.5 1-1.5s1 .777 1 1.5c0 .588-.202 1.139-.366 1.082A1.978 1.978 0 0 1 8 14zm-4.5-6a2.5 2.5 0 0 1 5 0h-5z"/></svg>';
            const message = `First Contentful Paint Score:${icon} ${fcpScore} `;
            github.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

# Path: .github/workflows/lighthouse.yml
