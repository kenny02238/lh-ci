name: Lighthouse CI

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  lhci:
    name: Lighthouse
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js 20.x
        uses: actions/setup-node@v3
        with:
          node-version: 20.x
      - name: yarn install, build
        run: |
          yarn install
          yarn run build
      - name: Run Lighthouse CI
        run: |
          yarn lhci autorun
      - name: Get last Lighthouse score
        id: last_lighthouse_score
        run: |
          last_score=$(git show --no-patch --format="%s" HEAD^ | grep -oE "\[Lighthouse: [0-9]+\]" | grep -oE "[0-9]+")
          echo "::set-output name=last_score::$last_score"
      - name: Comment on Pull Request
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const lastScore = ${{ steps.last_lighthouse_score.outputs.last_score }};
            const prNumber = github.context.payload.pull_request.number;
            const owner = github.context.payload.repository.owner.login;
            const repo = github.context.payload.repository.name;
            github.rest.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: prNumber,
              body: `Last Lighthouse score merged into main branch: ${lastScore}`
            });
